# encoding: utf-8
# -*- mode: ruby -*-
# vi: set ft=ruby :

CHEF_SERVER_SCRIPT = <<EOF.freeze
apt-get update
apt-get -y install curl

# ensure the time is up to date
echo "Synchronizing time..."
apt-get -y install ntp
service ntp stop
ntpdate -s time.nist.gov
service ntp start

# download the Chef server package
echo "Downloading the Chef server package..."
if [ ! -f /downloads/chef-server-core_12.11.1_amd64.deb ]; then
  wget -nv -P /downloads https://packages.chef.io/files/stable/chef-server/12.11.1/ubuntu/14.04/chef-server-core_12.11.1-1_amd64.deb
fi

# install the package
echo "Installing Chef server..."
sudo dpkg -i /downloads/chef-server-core_12.11.1-1_amd64.deb

# reconfigure and restart services
echo "Reconfiguring Chef server..."
sudo chef-server-ctl reconfigure
echo "Restarting Chef server..."
sudo chef-server-ctl restart

# wait for services to be fully available
echo "Waiting for services..."
until (curl -D - http://localhost:8000/_status) | grep "200 OK"; do sleep 15s; done
while (curl http://localhost:8000/_status) | grep "fail"; do sleep 15s; done

# create admin user
echo "Creating a user and organization..."
sudo chef-server-ctl user-create admin Bob Admin admin@4thcoffee.com insecurepassword --filename admin.pem
sudo chef-server-ctl org-create 4thcoffee "Fourth Coffee, Inc." --association_user admin --filename 4thcoffee-validator.pem

# copy admin RSA private key to share
echo "Copying admin key to /vagrant/secrets..."
mkdir -p /vagrant/secrets
cp -f /home/vagrant/admin.pem /vagrant/secrets

echo "Your Chef server is ready!"
EOF

NODE_SCRIPT = <<EOF.freeze
echo "Preparing node..."

# ensure the time is up to date
apt-get update
apt-get -y install ntp
service ntp stop
ntpdate -s time.nist.gov
service ntp start

echo "10.1.1.33 chef-server.test" | tee -a /etc/hosts
EOF

def set_hostname(server)
  server.vm.provision 'shell', inline: "hostname #{server.vm.hostname}"
end

Vagrant.configure(2) do |config|
  config.vm.define 'chef-server' do |cs|
    cs.vm.box = 'bento/ubuntu-14.04'
    cs.vm.box_version = '2.2.9'
    cs.vm.hostname = 'chef-server.test'
    cs.vm.network 'private_network', ip: '10.1.1.33'
    cs.vm.provision 'shell', inline: CHEF_SERVER_SCRIPT.dup
    set_hostname(cs)

    cs.vm.provider 'virtualbox' do |v|
      v.memory = 2048
      v.cpus = 2
    end
  end

  config.vm.define 'node1-ubuntu' do |n|
    n.vm.box = 'bento/ubuntu-14.04'
    n.vm.box_version = '2.2.9'
    n.vm.hostname = 'node1-ubuntu'
    n.vm.network 'private_network', ip: '10.1.1.34'
    n.vm.provision :shell, inline: NODE_SCRIPT.dup
    set_hostname(n)
  end
end


*********
# -*- mode: ruby -*-
# vi: set ft=ruby :

# default box when no VAGRANT_BOX / VAGRANT_BOX_URL environment is set
BOX_NAME = "quantal"
BOX_URL  = "http://cloud-images.ubuntu.com/vagrant/quantal/current/quantal-server-cloudimg-amd64-vagrant-disk1.box"

CHEF_CLIENT_INSTALL = <<-EOF
#!/bin/sh
test -d /opt/chef || {
  echo "Installing chef-client via omnibus"
  curl -L -s https://www.opscode.com/chef/install.sh | bash
}
EOF

CHEF_SERVER_INSTALL = <<-EOF
#!/bin/sh
test -d /opt/chef-server || {
  echo "Installing chef-server via omnibus"
  curl -L -s 'http://www.opscode.com/chef/download-server?p=ubuntu&pv=12.04&m=x86_64' > chef-server.dpkg
  dpkg -i chef-server.dpkg
  /opt/chef-server/bin/chef-server-ctl reconfigure >/dev/null
}
EOF

CHEF_CREATE_WORKSTATION = <<-EOF
#!/bin/sh
[ -f "/vagrant/.chef/chef-validator.pem" ] && {
  # compare chef-validator.pem file, don't continue when its already the same
  server_md5=`md5sum /etc/chef-server/chef-validator.pem  | cut -f1 -d' '`
  client_md5=`md5sum /vagrant/.chef/chef-validator.pem  | cut -f1 -d' '`
  [ "$server_md5" = "$client_md5" ] && exit 0
}
echo "Creating workstation knife configuration"
mkdir -p /vagrant/.chef
cp /etc/chef-server/chef-validator.pem /vagrant/.chef/
/opt/chef-server/bin/knife configure \
    --initial --yes --verbose --repository /vagrant \
    --server-url https://chefserver.vagrant.local \
    --validation-client-name chef-validator --validation-key /etc/chef-server/chef-validator.pem \
    --admin-client-name chef-webui --admin-client-key /etc/chef-server/chef-webui.pem \
    --user "workstation" --key /vagrant/.chef/workstation.pem
cat <<EOK > /vagrant/.chef/knife.rb
cwd                     = File.dirname(__FILE__)
log_level               :info   # valid values - :debug :info :warn :error :fatal
log_location            STDOUT
node_name               ENV.fetch('KNIFE_NODE_NAME', 'workstation')
client_key              ENV.fetch('KNIFE_CLIENT_KEY', File.join(cwd,'workstation.pem'))
chef_server_url         ENV.fetch('KNIFE_CHEF_SERVER_URL', 'https://chefserver.vagrant.local')
validation_client_name  ENV.fetch('KNIFE_CHEF_VALIDATION_CLIENT_NAME', 'chef-validator')
validation_key          ENV.fetch('KNIFE_CHEF_VALIDATION_KEY', File.join(cwd,'chef-validator.pem'))
syntax_check_cache_path File.join(cwd,'syntax_check_cache')
cookbook_path           File.join(cwd,'..','cookbooks')
data_bag_path           File.join(cwd,'..','data_bags')
role_path               File.join(cwd,'..','roles')
EOK
EOF

Vagrant::Config.run do |config|
  config.vm.box = ENV.fetch("VAGRANT_BOX", BOX_NAME)
  config.vm.box_url = ENV.fetch("VAGRANT_BOX_URL", BOX_URL)

  config.vm.define :chef_server do |v|
    v.vm.customize ["modifyvm", :id, "--memory", 1024]
    v.vm.network :hostonly, "192.168.33.10"
    v.vm.host_name = "chefserver.vagrant.local"
    v.vm.provision :shell, :inline => CHEF_CLIENT_INSTALL
    v.vm.provision :shell, :inline => CHEF_SERVER_INSTALL
    v.vm.provision :shell, :inline => CHEF_CREATE_WORKSTATION
  end

  config.vm.define :client do |v|
    v.vm.network :hostonly, "192.168.33.20"
    v.vm.host_name = "client.vagrant.local"
    v.vm.provision :shell, :inline => CHEF_CLIENT_INSTALL
    v.vm.provision :chef_client do |chef|
      chef.chef_server_url = 'https://chefserver.vagrant.local'
      chef.validation_key_path = ".chef/chef-validator.pem"
      chef.validation_client_name = "chef-validator"
      chef.run_list = [
        # ... put something in here, or knife node edit client.vagrant.local
      ]
    end
  end

end